From d0cba8b2f6905dfc08cbb4ccc4006e3234564449 Mon Sep 17 00:00:00 2001
From: Balint Reczey <balint@balintreczey.hu>
Date: Sun, 30 Jun 2013 02:39:31 +0200
Subject: [PATCH 1/2] Fix options parsing in snacc

The crashes in the parsing logic has been reported by The Mayhem Team
at http://www.forallsecure.com/bug-reports/6f5f79ad3f80cffe072b7133a3b8224d1b18d2b5
---
 compiler/core/snacc.c |   27 ++++++++++++++++++++++-----
 1 file changed, 22 insertions(+), 5 deletions(-)

diff --git a/compiler/core/snacc.c b/compiler/core/snacc.c
index d0e4923..96b2683 100644
--- a/compiler/core/snacc.c
+++ b/compiler/core/snacc.c
@@ -448,11 +448,15 @@ int main PARAMS ((argc, argv),
                         usefulTypeModFileName = &argv[currArg][2];
                         currArg++;
                     }
-                    else
+                    else if (currArg+1 < argc)
                     {
                         usefulTypeModFileName = argv[currArg+1];
                         currArg += 2;
                     }
+                    else /* no file to parse after -u */
+                    {
+                        goto error;
+                    }
                 break;
 
                 case 'l':
@@ -461,11 +465,16 @@ int main PARAMS ((argc, argv),
                         longJmpVal = atoi (&argv[currArg][2]);
                         currArg++;
                     }
-                    else
+                    else if (currArg+1 < argc)
                     {
                         longJmpVal = atoi (argv[currArg+1]);
                         currArg += 2;
                     }
+                    else /* no number to parse after -l */
+                    {
+                        goto error;
+		    }
+
                 break;
 
                 case 'T':
@@ -476,11 +485,15 @@ int main PARAMS ((argc, argv),
                         tblFileName = &argv[currArg][2];
                         currArg++;
                     }
-                    else
+                    else if (currArg+1 < argc)
                     {
                         tblFileName = argv[currArg+1];
                         currArg += 2;
                     }
+                    else /* no file to parse after -T */
+                    {
+                        goto error;
+		    }
                 break;
 
 
@@ -492,11 +505,15 @@ int main PARAMS ((argc, argv),
                             maxFileNameLenG = atoi (&argv[currArg][3]);
                             currArg++;
                         }
-                        else
+                        else if (currArg+1 < argc)
                         {
                             maxFileNameLenG = atoi (argv[currArg+1]);
                             currArg += 2;
                         }
+                        else /* no parameter to parse after -mf */
+                        {
+			  goto error;
+                        }
                         break;
                     }
 #if META
@@ -535,7 +552,7 @@ int main PARAMS ((argc, argv),
 
 error:
                 default:
-                    fprintf (stderr, "%s: ERROR---unknown cmd line option `%s'\n\n", argv[0], argv[currArg]);
+                    fprintf (stderr, "%s: ERROR---unknown or improperly used cmd line option `%s'\n\n", argv[0], argv[currArg]);
                     Usage (argv[0], stderr);
                     exit (1);
             }
-- 
1.7.10.4

From 9a04e733fac1874d6b99a9906f5e8b3b4b567f0e Mon Sep 17 00:00:00 2001
From: Balint Reczey <balint@balintreczey.hu>
Date: Sun, 30 Jun 2013 02:41:43 +0200
Subject: [PATCH 2/2] Fix printing version information in berdecode

The crashes in the printing logic has been reported by The Mayhem Team
at http://www.forallsecure.com/bug-reports/6f5f79ad3f80cffe072b7133a3b8224d1b18d2b5
---
 tbl-tools/berdecode/berdecode.c |   20 +++-----------------
 1 file changed, 3 insertions(+), 17 deletions(-)

diff --git a/tbl-tools/berdecode/berdecode.c b/tbl-tools/berdecode/berdecode.c
index 012ef86..62b0001 100644
--- a/tbl-tools/berdecode/berdecode.c
+++ b/tbl-tools/berdecode/berdecode.c
@@ -1,6 +1,7 @@
 #include "tbl-gen.h"
 #include "sbuf.h"
 #include "tbl-dbg.h"
+#include "version.h"
 
 #if TIME_WITH_SYS_TIME
 # include <sys/time.h>
@@ -189,27 +190,12 @@ int main (int argc, char* argv[])
 	}
     if (!files)
 	{
-	char* revision = "$Revision: 1.3 $";
-	char* date = "$Date: 1997/09/16 15:05:10 $";
-	char* p;
-	p = strchr(revision,' ');
-	if (p)
-	    revision = p+1;
-	p = strchr(revision,' ');
-	if (p)
-	    *p = '\0';
-	p = strchr(date,' ');
-	if (p)
-	    date = p+1;
-	p = strchr(date,' ');
-	if (p)
-	    *p = '\0';
 	fprintf(stderr,"Usage: %s [-s|-strip <bytestostrip>] [-d|-debug]\n",
 		progname);
-	fprintf(stderr,"        [-T|-table <tablefilename] {<filename>|-}\n");
+	fprintf(stderr,"        [-T|-table <tablefilename>] {<filename>|-}\n");
 	fprintf(stderr,"\n");
 	fprintf(stderr,"This is berdecode, revision %s as of %s.\n",
-		revision,date);
+		VERSION, RELDATE);
 	fprintf(stderr,"This program reads a binary ASN.1 grammar file generated by snacc -T\n");
 	fprintf(stderr,"and uses it to decode ASN.1 BER encoded data from files or stdin.\n");
 	fprintf(stderr,"\n");
-- 
1.7.10.4

